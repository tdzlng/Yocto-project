#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/spi/spi.h>
#include <linux/gpio/consumer.h>
#include <linux/delay.h>

typedef unsigned char UI_8;

#define SPI_MODE_0 (0|0)
#define SPI_MODE_1 (0|SPI_CPHA)
#define SPI_MODE_2 (SPI_CPOL|0)
#define SPI_MODE_3 (SPI_CPOL|SPI_CPHA)

struct ssd1306_device {
    struct spi_device *spi;
    struct gpio_desc *dc_gpio;
    struct gpio_desc *res_gpio; // Reset GPIO
    UI_8 *buffer; // Display buffer (128x64/8 = 1024 bytes)
};

const UI_8 test_data[]={
    56,	68,	70,	192,	48,	72,	192,	64,	
    0,	0,	0,	0,	0,	0,	0,	0,

    0x7F, 0x41, 0x41, 0x22, 0x1C,
    0x38, 0x54, 0x54, 0x54, 0x18,
    0x1C, 0x20, 0x40, 0x20, 0x1C,
    0x00, 0x41, 0x7F, 0x40, 0x00,
    0x00, 0x44, 0x7D, 0x40, 0x00,
    0x7C, 0x08, 0x04, 0x04, 0x78,
    0x3C, 0x40, 0x40, 0x20, 0x7C,
    0x44, 0x28, 0x10, 0x28, 0x44,

    0,	0,	0,	0,	0,	0,	0,	0,	
    56,	68,	70,	192,	48,	72,	192,	64
};

const UI_8 init_cmd[] = {
    0xAE,   //  Display OFF
    0xD5,   //  Set display clock divide ratio/oscillator frequency
    0x80,   //  Set divide ratio
    0xA8,   //  Set multiplex ratio
    0x3F,   //  1/64 duty
    0xD3,   //  Set display offset
    0x00,   //  No offset
    0x40,   //  Set display start line
    0x20,   //  Set memory addressing mode
    0x00,   //  Horizontal addressing mode
    0xA1,   //  Set segment remap
    0xC8,   //  Set COM output scan direction
    0xDA,   //  Set COM pins hardware configuration
    0x12,   //  Sequential COM, Disable COM LR Remap
    0x81,   //  Set contrast control
    0xCF,   //  Contrast value
    0xD9,   //  Set pre-charge period
    0xF1,   //  Pre-charge period
    0xDB,   //  Set VCOMH deselect level
    0x40,   //  VCOMH level
    0x2E,   //  Deactivate scroll
    0xA4,   //  Entire display ON
    0xA6,   //  Normal display
    0x8D,   //  Charge pump setting
    0x14,   //  Enable charge pump
    0xAF    //  Display ON     
};

const UI_8 reset_pos_cmd[] = {
    0x21, 0x00, 0x7F, // Set column address
    0x22, 0x00, 0x07  // Set page address
};

const UI_8 test_data2[] = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x80, 0xaa, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x50, 0x55, 0x15, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0xa8, 0xaa, 0x2a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x54, 0x55, 0x55, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0xaa, 0xaa, 0xaa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x55, 0x55, 0x55, 0x31, 0xef, 0x45, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x1f, 0x00, 0x00, 
	0x00, 0x80, 0xaa, 0xaa, 0xaa, 0x22, 0x29, 0x25, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x1f, 0x00, 0x00, 
	0x00, 0x00, 0x55, 0x55, 0x55, 0x21, 0x29, 0x11, 0x00, 0x00, 0x00, 0x00, 0x06, 0x18, 0x00, 0x00, 
	0x00, 0x80, 0x2a, 0x00, 0xa8, 0x22, 0x29, 0x59, 0x00, 0x00, 0x00, 0x00, 0x06, 0x18, 0x00, 0x00, 
	0x00, 0x00, 0x05, 0x55, 0x41, 0x71, 0xef, 0x4d, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x07, 0x00, 0x00, 
	0x00, 0x80, 0xa0, 0xaa, 0x0a, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x07, 0x00, 0x00, 
	0x00, 0x00, 0x54, 0x55, 0x55, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xff, 0x7f, 0x00, 0x00, 
	0x00, 0x00, 0xaa, 0xaa, 0xaa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xff, 0x7f, 0x00, 0x00, 
	0x00, 0x00, 0x55, 0x55, 0x55, 0xf1, 0x5e, 0x04, 0x00, 0x00, 0x00, 0x80, 0x01, 0x60, 0x00, 0x00, 
	0x00, 0x80, 0xaa, 0xaa, 0xaa, 0x92, 0x52, 0x02, 0x00, 0x00, 0x00, 0x80, 0x01, 0x60, 0x00, 0x00, 
	0x00, 0x00, 0x55, 0x55, 0x55, 0xf1, 0x12, 0x01, 0x00, 0x00, 0x00, 0x60, 0x00, 0x80, 0x01, 0x00, 
	0x00, 0x80, 0xaa, 0xaa, 0xaa, 0x92, 0x92, 0x05, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x00, 0x15, 0x00, 0x50, 0xf1, 0xde, 0x04, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x80, 0x82, 0xaa, 0x82, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x00, 0x50, 0x55, 0x15, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x00, 0xaa, 0xaa, 0xaa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x00, 0x55, 0x55, 0x55, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x80, 0xaa, 0xaa, 0xaa, 0xf2, 0x5e, 0x04, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x00, 0x55, 0x55, 0x55, 0x31, 0x52, 0x02, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x80, 0xaa, 0xaa, 0xaa, 0xf2, 0x12, 0x01, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x00, 0x55, 0x55, 0x55, 0xb1, 0x92, 0x05, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x80, 0x0a, 0x00, 0xa0, 0xf2, 0xde, 0x04, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x00, 0xc1, 0xff, 0x07, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x00, 0xfc, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x80, 0xff, 0xff, 0xff, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x80, 0xff, 0xff, 0xff, 0xc3, 0x5e, 0x04, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x80, 0xff, 0xff, 0xff, 0xa3, 0x52, 0x02, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x80, 0xff, 0xff, 0xff, 0xb3, 0x12, 0x01, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x80, 0xff, 0xff, 0xff, 0xf3, 0x92, 0x05, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x80, 0xff, 0xff, 0xff, 0x83, 0xde, 0x04, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x80, 0x07, 0x00, 0xe0, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x00, 0xe0, 0xff, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x00, 0xff, 0xff, 0xff, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x80, 0xff, 0xff, 0xff, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x80, 0xff, 0xff, 0xff, 0xf3, 0x5e, 0x04, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x80, 0xff, 0xff, 0xff, 0xc3, 0x52, 0x02, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x80, 0xff, 0xff, 0xff, 0x33, 0x12, 0x01, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x80, 0xff, 0xff, 0xff, 0x33, 0x92, 0x05, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x80, 0xff, 0xff, 0xff, 0xf3, 0xde, 0x04, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x80, 0x01, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x00, 0xf8, 0xff, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x80, 0xff, 0xff, 0xff, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x80, 0xff, 0xff, 0xff, 0x33, 0x2f, 0x02, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x80, 0xff, 0xff, 0xff, 0x23, 0x29, 0x01, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x80, 0xff, 0xff, 0xff, 0x23, 0x89, 0x00, 0x00, 0x00, 0x00, 0x60, 0xff, 0xbf, 0x01, 0x00, 
	0x00, 0x80, 0xff, 0xff, 0xff, 0x23, 0xc9, 0x02, 0x00, 0x00, 0x00, 0x60, 0x00, 0x80, 0x01, 0x00, 
	0x00, 0x80, 0xff, 0xff, 0xff, 0x73, 0x6f, 0x02, 0x00, 0x00, 0x00, 0xe0, 0xff, 0xff, 0x01, 0x00, 
	0x00, 0x80, 0xff, 0xff, 0xff, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0xff, 0xff, 0x01, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

static int ssd1306_write_cmd(struct ssd1306_device *device, UI_8 *cmd, size_t len)
{
    struct spi_message msg;
    struct spi_transfer transfer;
    int ret;

    spi_message_init(&msg);
    memset(&transfer, 0, sizeof(transfer));
    transfer.tx_buf = cmd;
    transfer.len = len;
    spi_message_add_tail(&transfer, &msg);

    gpiod_set_value(device->dc_gpio, 0); // Command mode
    ret = spi_sync(device->spi, &msg);
    return ret;
}

static int ssd1306_write_data(struct ssd1306_device *device, UI_8 *buf, size_t len)
{
    struct spi_message msg;
    struct spi_transfer transfer;
    int ret;

    spi_message_init(&msg);
    memset(&transfer, 0, sizeof(transfer));
    transfer.tx_buf = buf;
    transfer.len = len;
    spi_message_add_tail(&transfer, &msg);

    gpiod_set_value(device->dc_gpio, 1); // Data mode
    ret = spi_sync(device->spi, &msg);
    return ret;
}

static int ssd1306_write_single_cmd(struct ssd1306_device *device, UI_8 cmd)
{
    return ssd1306_write_cmd(device, &cmd, 1);
}

static void ssd1306_init_display(struct ssd1306_device *device)
{
    // Initialization sequence for SSD1306 128x64
    gpiod_set_value(device->res_gpio, 1); // Release reset
    msleep(10); // Wait for display to initialize
    gpiod_set_value(device->res_gpio, 0); // Reset display
    msleep(10); // Wait for reset
    gpiod_set_value(device->res_gpio, 1); // Release reset
    msleep(10); // Wait for display to come out of reset


    ssd1306_write_cmd(device, init_cmd, sizeof(init_cmd));
    pr_info("SSD1306 display initialized\n");
}


static void ssd1306_update_display(struct ssd1306_device *device)
{
    // Set column and page address
    ssd1306_write_cmd(device, reset_pos_cmd, sizeof(reset_pos_cmd));

    // Write entire buffer
    ssd1306_write_data(device, device->buffer, 1024);
}

static int ssd1306_probe(struct spi_device *spi)
{
    struct ssd1306_device *device;
    int ret;

    // Allocate driver device
    device = devm_kzalloc(&spi->dev, sizeof(*device), GFP_KERNEL);
    if (!device)
        return -ENOMEM;

    // Initialize device structure
    device->spi = spi;
    device->buffer = devm_kzalloc(&spi->dev, 1024, GFP_KERNEL); // 128x64/8
    if (!device->buffer)
        return -ENOMEM;

    // Get DC GPIO
    device->dc_gpio = devm_gpiod_get(&spi->dev, "dc", GPIOD_OUT_LOW);
    if (IS_ERR(device->dc_gpio)) {
        dev_err(&spi->dev, "Failed to get DC GPIO\n");
        return PTR_ERR(device->dc_gpio);
    }

    // Get Reset GPIO
    device->res_gpio = devm_gpiod_get(&spi->dev, "res", GPIOD_OUT_HIGH);
    if (IS_ERR(device->res_gpio)) {
        dev_err(&spi->dev, "Failed to get Reset GPIO\n");
        return PTR_ERR(device->res_gpio);
    }

    spi_set_drvdata(spi, device);

    // Setup SPI
    spi->mode = SPI_MODE_1;
    spi->bits_per_word = 8;
    spi->max_speed_hz = 1000000; // 1 MHz
    ret = spi_setup(spi);
    if (ret < 0) {
        dev_err(&spi->dev, "SPI setup failed\n");
        return ret;
    }

    pr_info("ssd1306 kernel module spi\n");

    // Initialize display
    ssd1306_init_display(device);
    pr_info("dc %d res %d ssd1306 init display\n",gpiod_get_value(device->dc_gpio), gpiod_get_value(device->res_gpio));
    msleep(100); // Wait for display to be ready

    // Clear buffer
    memset(device->buffer, 0, 1024);

    UI_8* ptr = device->buffer;

    memcpy(ptr + 4, test_data, sizeof(test_data));

    // Update display
    pr_info("dc %d res %d check message here\n", gpiod_get_value(device->dc_gpio), gpiod_get_value(device->res_gpio));
    ssd1306_update_display(device);
    msleep(10); // Wait for display to update
    pr_info("dc %d res %d 2nd\n", gpiod_get_value(device->dc_gpio), gpiod_get_value(device->res_gpio));
    ssd1306_update_display(device);
    msleep(3000); // Wait for display to update
    pr_info("dc %d res %d test 2\n", gpiod_get_value(device->dc_gpio), gpiod_get_value(device->res_gpio));
    memcpy(device->buffer, test_data2, sizeof(test_data2));
    ssd1306_update_display(device);

    dev_info(&spi->dev, "SSD1306 initialized\n");
    return 0;
}

static void ssd1306_remove(struct spi_device *spi)
{
    struct ssd1306_device *device = spi_get_drvdata(spi);

    // Turn off display
    ssd1306_write_single_cmd(device, 0xAE); // Display OFF
    return ;
}

static const struct of_device_id ssd1306_of_match[] = {
    { .compatible = "solomon,ssd1306_spi" },
    { }
};
MODULE_DEVICE_TABLE(of, ssd1306_of_match);

static struct spi_driver ssd1306_driver = {
    .driver = {
        .name = "ssd1306",
        .of_match_table = ssd1306_of_match,
    },
    .probe = ssd1306_probe,
    .remove = ssd1306_remove,
};

module_spi_driver(ssd1306_driver);

MODULE_AUTHOR("Tran Long");
MODULE_DESCRIPTION("SSD1306 SPI OLED Driver");
MODULE_LICENSE("GPL");